#!/bin/bash

BFG_VERSION=1.14.0
BFG=bfg-$BFG_VERSION.jar
if ! ls "/home/ubuntu/$BFG"; then
    wget https://repo1.maven.org/maven2/com/madgag/bfg/$BFG_VERSION/$BFG -P/home/ubuntu
fi

# Cleanup unnecessary files and optimize the local repository
git gc

# Run BFG repo cleaner to remove large files from the commit history
java -jar /home/ubuntu/$BFG --no-blob-protection --strip-blobs-bigger-than 100M
git reflog expire --expire=now --all
git gc --prune=now --aggressive

# Unstage all changes
git reset .

# Automatically ignore all large files
find . -size +100M | cut -c 2- | cat >> .gitignore
awk '!NF||$1~/^#/ {print; next} {$1=$1} !seen[$0]++' .gitignore > /tmp/.gitignore
mv -f /tmp/.gitignore .gitignore
